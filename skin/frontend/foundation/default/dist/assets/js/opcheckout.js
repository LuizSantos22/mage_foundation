var Checkout=Class.create();Checkout.prototype={initialize:function(e,t){this.accordion=e,this.progressUrl=t.progress,this.reviewUrl=t.review,this.saveMethodUrl=t.saveMethod,this.failureUrl=t.failure,this.billingForm=!1,this.shippingForm=!1,this.syncBillingShipping=!1,this.method="",this.payment="",this.loadWaiting=!1,this.steps=["login","billing","shipping","shipping_method","payment","review"],this.currentStep="billing",this.accordion.sections.each(function(e){Event.observe($(e).down(".step-title"),"click",this._onSectionClick.bindAsEventListener(this))}.bind(this)),this.accordion.disallowAccessToNextSections=!0},_onSectionClick:function(e){var t=$(Event.element(e).up(".section"));if(t.hasClassName("allow"))return Event.stop(e),this.gotoSection(t.readAttribute("id").replace("opc-",""),!1),!1},ajaxFailure:function(){location.href=encodeURI(this.failureUrl)},reloadProgressBlock:function(e){this.reloadStep(e),this.syncBillingShipping&&(this.syncBillingShipping=!1,this.reloadStep("shipping"))},reloadStep:function(e){new Ajax.Updater(e+"-progress-opcheckout",this.progressUrl,{method:"get",onFailure:this.ajaxFailure.bind(this),onComplete:function(){this.checkout.resetPreviousSteps()},parameters:e?{prevStep:e}:null})},reloadReviewBlock:function(){new Ajax.Updater("checkout-review-load",this.reviewUrl,{method:"get",onFailure:this.ajaxFailure.bind(this)})},_disableEnableAll:function(e,t){var i=e.descendants();for(var s in i)i[s].disabled=t;e.disabled=t},setLoadWaiting:function(e,t){var i;if(e)this.loadWaiting&&this.setLoadWaiting(!1),(i=$(e+"-buttons-container")).addClassName("disabled"),i.setStyle({opacity:.5}),this._disableEnableAll(i,!0),Element.show(e+"-please-wait");else if(this.loadWaiting){i=$(this.loadWaiting+"-buttons-container");var s=!!t;s||(i.removeClassName("disabled"),i.setStyle({opacity:1})),this._disableEnableAll(i,s),Element.hide(this.loadWaiting+"-please-wait")}this.loadWaiting=e},gotoSection:function(e,t){t&&this.reloadProgressBlock(this.currentStep),this.currentStep=e,$("opc-"+e).addClassName("allow"),this.accordion.openSection("opc-"+e),t||this.resetPreviousSteps();var i=jQuery("#opc-"+e).offset().top;jQuery("html, body").delay(10).animate({scrollTop:i},50)},resetPreviousSteps:function(){for(var e=this.steps.indexOf(this.currentStep);e<this.steps.length;e++){var t=this.steps[e]+"-progress-opcheckout";$(t)&&($(t).select(".changelink").invoke("remove"),$(t).select("dt").invoke("removeClassName","complete"),$(t).select("dd.complete").invoke("remove"))}},changeSection:function(e){var t=e.replace("opc-","");this.gotoSection(t,!1)},setMethod:function(){if($("login:guest")&&$("login:guest").checked)this.method="guest",new Ajax.Request(this.saveMethodUrl,{method:"post",onFailure:this.ajaxFailure.bind(this),parameters:{method:"guest"}}),Element.hide("register-customer-password"),this.gotoSection("billing",!0);else{if(!$("login:register")||!$("login:register").checked&&"hidden"!=$("login:register").type)return alert(Translator.translate("Please choose to register or to checkout as a guest").stripTags()),!1;this.method="register",new Ajax.Request(this.saveMethodUrl,{method:"post",onFailure:this.ajaxFailure.bind(this),parameters:{method:"register"}}),Element.show("register-customer-password"),this.gotoSection("billing",!0)}document.body.fire("login:setMethod",{method:this.method})},setBilling:function(){$("billing:use_for_shipping_yes")&&$("billing:use_for_shipping_yes").checked?(shipping.syncWithBilling(),$("opc-shipping").addClassName("allow"),this.gotoSection("shipping_method",!0)):($("billing:use_for_shipping_no")&&$("billing:use_for_shipping_no").checked?$("shipping:same_as_billing").checked=!1:$("shipping:same_as_billing").checked=!0,this.gotoSection("shipping",!0))},setShipping:function(){this.gotoSection("shipping_method",!0)},setShippingMethod:function(){this.gotoSection("payment",!0)},setPayment:function(){this.gotoSection("review",!0)},setReview:function(){this.reloadProgressBlock()},back:function(){if(!this.loadWaiting){for(var e=this.steps.indexOf(this.currentStep),t=this.steps[--e],i=$("opc-"+t);null===i&&0<e;)--e,t=this.steps[e],i=$("opc-"+t);this.changeSection("opc-"+t)}},setStepResponse:function(e){return e.update_section&&$("checkout-"+e.update_section.name+"-load").update(e.update_section.html),e.allow_sections&&e.allow_sections.each(function(e){$("opc-"+e).addClassName("allow")}),e.duplicateBillingInfo&&(this.syncBillingShipping=!0,shipping.setSameAsBilling(!0)),e.goto_section?(this.gotoSection(e.goto_section,!0),!0):!!e.redirect&&(location.href=encodeURI(e.redirect),!0)}};var Billing=Class.create();Billing.prototype={initialize:function(e,t,i){this.form=e,$(this.form)&&$(this.form).observe("submit",function(e){this.save(),Event.stop(e)}.bind(this)),this.addressUrl=t,this.saveUrl=i,this.onAddressLoad=this.fillForm.bindAsEventListener(this),this.onSave=this.nextStep.bindAsEventListener(this),this.onComplete=this.resetLoadWaiting.bindAsEventListener(this),this.formvalid=1},setAddress:function(e){e?new Ajax.Request(this.addressUrl+e,{method:"get",onSuccess:this.onAddressLoad,onFailure:checkout.ajaxFailure.bind(checkout)}):this.fillForm(!1)},newAddress:function(e){e?(this.resetSelectedAddress(),Element.show("billing-new-address-form")):Element.hide("billing-new-address-form")},resetSelectedAddress:function(){var e=$("billing-address-select");e&&(e.value="")},fillForm:function(e){var t=e.responseJSON||e.responseText.evalJSON(!0)||{};e||Object.keys(t).length||this.resetSelectedAddress();var i=Form.getElements(this.form);for(var s in i)if(i.hasOwnProperty(s)&&i[s].id){var n=i[s].id.replace(/^billing:/,"");i[s].value=t[n]?t[n]:"","country_id"==n&&billingForm&&billingForm.elementChildLoad(i[s])}},setUseForShipping:function(e){$("shipping:same_as_billing").checked=e},save:function(){0==checkout.loadWaiting&&new Validation(this.form).validate()&&(checkout.setLoadWaiting("billing"),new Ajax.Request(this.saveUrl,{method:"post",onComplete:this.onComplete,onSuccess:this.onSave,onFailure:checkout.ajaxFailure.bind(checkout),parameters:Form.serialize(this.form)}))},resetLoadWaiting:function(e){checkout.setLoadWaiting(!1),document.body.fire("billing-request:completed",{transport:e})},nextStep:function(e){var t=e.responseJSON||e.responseText.evalJSON(!0)||{};if(t.error){if(Object.isString(t.message))alert(t.message.stripTags().toString());else{window.billingRegionUpdater&&billingRegionUpdater.update();var i=t.message;Object.isArray(i)&&alert(i.join("\n")),alert(i.stripTags().toString())}return!1}checkout.setStepResponse(t),payment&&payment.initWhatIsCvvListeners()}};var Shipping=Class.create();Shipping.prototype={initialize:function(e,t,i,s){this.form=e,$(this.form)&&$(this.form).observe("submit",function(e){this.save(),Event.stop(e)}.bind(this)),this.addressUrl=t,this.saveUrl=i,this.methodsUrl=s,this.onAddressLoad=this.fillForm.bindAsEventListener(this),this.onSave=this.nextStep.bindAsEventListener(this),this.onComplete=this.resetLoadWaiting.bindAsEventListener(this)},setAddress:function(e){e?new Ajax.Request(this.addressUrl+e,{method:"get",onSuccess:this.onAddressLoad,onFailure:checkout.ajaxFailure.bind(checkout)}):this.fillForm(!1)},newAddress:function(e){e?(this.resetSelectedAddress(),Element.show("shipping-new-address-form")):Element.hide("shipping-new-address-form"),shipping.setSameAsBilling(!1)},resetSelectedAddress:function(){var e=$("shipping-address-select");e&&(e.value="")},fillForm:function(e){var t=e.responseJSON||e.responseText.evalJSON(!0)||{};e||Object.keys(t).length||this.resetSelectedAddress();var i=Form.getElements(this.form);for(var s in i)if(i.hasOwnProperty(s)&&i[s].id){var n=i[s].id.replace(/^shipping:/,"");i[s].value=t[n]?t[n]:"","country_id"==n&&shippingForm&&shippingForm.elementChildLoad(i[s])}},setSameAsBilling:function(e){($("shipping:same_as_billing").checked=e)&&this.syncWithBilling()},syncWithBilling:function(){if($("billing-address-select")&&this.newAddress(!$("billing-address-select").value),$("shipping:same_as_billing").checked=!0,$("billing-address-select")&&$("billing-address-select").value)$("shipping-address-select").value=$("billing-address-select").value;else{for(var e in arrElements=Form.getElements(this.form),arrElements)if(arrElements[e].id){var t=$(arrElements[e].id.replace(/^shipping:/,"billing:"));t&&(arrElements[e].value=t.value)}shippingRegionUpdater.update(),$("shipping:region_id").value=$("billing:region_id").value,$("shipping:region").value=$("billing:region").value}},setRegionValue:function(){$("shipping:region").value=$("billing:region").value},save:function(){0==checkout.loadWaiting&&new Validation(this.form).validate()&&(checkout.setLoadWaiting("shipping"),new Ajax.Request(this.saveUrl,{method:"post",onComplete:this.onComplete,onSuccess:this.onSave,onFailure:checkout.ajaxFailure.bind(checkout),parameters:Form.serialize(this.form)}))},resetLoadWaiting:function(){checkout.setLoadWaiting(!1)},nextStep:function(e){var t=e.responseJSON||e.responseText.evalJSON(!0)||{};if(t.error){if(Object.isString(t.message))alert(t.message.stripTags().toString());else{window.shippingRegionUpdater&&shippingRegionUpdater.update();var i=t.message;Object.isArray(i)&&alert(i.join("\n")),alert(i.stripTags().toString())}return!1}checkout.setStepResponse(t)}};var ShippingMethod=Class.create();ShippingMethod.prototype={initialize:function(e,t){this.form=e,$(this.form)&&$(this.form).observe("submit",function(e){this.save(),Event.stop(e)}.bind(this)),this.saveUrl=t,this.validator=new Validation(this.form),this.onSave=this.nextStep.bindAsEventListener(this),this.onComplete=this.resetLoadWaiting.bindAsEventListener(this)},validate:function(){var e=document.getElementsByName("shipping_method");if(0==e.length)return alert(Translator.translate("Your order cannot be completed at this time as there is no shipping methods available for it. Please make necessary changes in your shipping address.").stripTags()),!1;if(!this.validator.validate())return!1;for(var t=0;t<e.length;t++)if(e[t].checked)return!0;return alert(Translator.translate("Please specify shipping method.").stripTags()),!1},save:function(){0==checkout.loadWaiting&&this.validate()&&(checkout.setLoadWaiting("shipping-method"),new Ajax.Request(this.saveUrl,{method:"post",onComplete:this.onComplete,onSuccess:this.onSave,onFailure:checkout.ajaxFailure.bind(checkout),parameters:Form.serialize(this.form)}))},resetLoadWaiting:function(e){checkout.setLoadWaiting(!1)},nextStep:function(e){var t=e.responseJSON||e.responseText.evalJSON(!0)||{};return t.error?(alert(t.message.stripTags().toString()),!1):(t.update_section&&$("checkout-"+t.update_section.name+"-load").update(t.update_section.html),payment.initWhatIsCvvListeners(),t.goto_section?(checkout.gotoSection(t.goto_section,!0),void checkout.reloadProgressBlock()):(t.payment_methods_html&&$("checkout-payment-method-load").update(t.payment_methods_html),void checkout.setShippingMethod()))}};var Payment=Class.create();Payment.prototype={beforeInitFunc:$H({}),afterInitFunc:$H({}),beforeValidateFunc:$H({}),afterValidateFunc:$H({}),initialize:function(e,t){this.form=e,this.saveUrl=t,this.onSave=this.nextStep.bindAsEventListener(this),this.onComplete=this.resetLoadWaiting.bindAsEventListener(this)},addBeforeInitFunction:function(e,t){this.beforeInitFunc.set(e,t)},beforeInit:function(){this.beforeInitFunc.each(function(e){e.value()})},init:function(){this.beforeInit();var e=Form.getElements(this.form);$(this.form)&&$(this.form).observe("submit",function(e){this.save(),Event.stop(e)}.bind(this));for(var t=null,i=0;i<e.length;i++)"payment[method]"==e[i].name||"form_key"==e[i].name?e[i].checked&&(t=e[i].value):e[i].disabled=!0,e[i].setAttribute("autocomplete","off");t&&this.switchMethod(t),this.afterInit()},addAfterInitFunction:function(e,t){this.afterInitFunc.set(e,t)},afterInit:function(){this.afterInitFunc.each(function(e){e.value()})},switchMethod:function(e){this.currentMethod&&$("payment_form_"+this.currentMethod)&&(this.changeVisible(this.currentMethod,!0),$("payment_form_"+this.currentMethod).fire("payment-method:switched-off",{method_code:this.currentMethod})),$("payment_form_"+e)?(this.changeVisible(e,!1),$("payment_form_"+e).fire("payment-method:switched",{method_code:e})):document.body.fire("payment-method:switched",{method_code:e}),"free"==e&&1e-4<quoteBaseGrandTotal&&!($("use_reward_points")&&$("use_reward_points").checked||$("use_customer_balance")&&$("use_customer_balance").checked)&&$("p_method_"+e)&&($("p_method_"+e).checked=!1,$("dt_method_"+e)&&$("dt_method_"+e).hide(),$("dd_method_"+e)&&$("dd_method_"+e).hide()),e&&(this.lastUsedMethod=e),this.currentMethod=e},changeVisible:function(e,t){var i="payment_form_"+e;[i+"_before",i,i+"_after"].each(function(e){element=$(e),element&&(element.style.display=t?"none":"",element.select("input","select","textarea","button").each(function(e){e.disabled=t}))})},addBeforeValidateFunction:function(e,t){this.beforeValidateFunc.set(e,t)},beforeValidate:function(){var t=!0,i=!1;return this.beforeValidateFunc.each(function(e){i=!0,0==e.value()&&(t=!1)}.bind(this)),i||(t=!1),t},validate:function(){var e=this.beforeValidate();if(e)return!0;var t=document.getElementsByName("payment[method]");if(0==t.length)return alert(Translator.translate("Your order cannot be completed at this time as there is no payment methods available for it.").stripTags()),!1;for(var i=0;i<t.length;i++)if(t[i].checked)return!0;return!!(e=this.afterValidate())||(alert(Translator.translate("Please specify payment method.").stripTags()),!1)},addAfterValidateFunction:function(e,t){this.afterValidateFunc.set(e,t)},afterValidate:function(){var t=!0,i=!1;return this.afterValidateFunc.each(function(e){i=!0,0==e.value()&&(t=!1)}.bind(this)),i||(t=!1),t},save:function(){if(0==checkout.loadWaiting){var e=new Validation(this.form);this.validate()&&e.validate()&&(checkout.setLoadWaiting("payment"),new Ajax.Request(this.saveUrl,{method:"post",onComplete:this.onComplete,onSuccess:this.onSave,onFailure:checkout.ajaxFailure.bind(checkout),parameters:Form.serialize(this.form)}))}},resetLoadWaiting:function(){checkout.setLoadWaiting(!1)},nextStep:function(e){var t=e.responseJSON||e.responseText.evalJSON(!0)||{};if(t.error){if(t.fields){for(var i=t.fields.split(","),s=0;s<i.length;s++){var n;(n=$(i[s]))&&Validation.ajaxError(n,t.error)}return}Object.isString(t.message)?alert(t.message.stripTags().toString()):alert(t.error.stripTags().toString())}else checkout.setStepResponse(t)},initWhatIsCvvListeners:function(){$$(".cvv-what-is-this").each(function(e){Event.observe(e,"click",toggleToolTip)})}};var Review=Class.create();Review.prototype={initialize:function(e,t,i){this.saveUrl=e,this.successUrl=t,this.agreementsForm=i,this.onSave=this.nextStep.bindAsEventListener(this),this.onComplete=this.resetLoadWaiting.bindAsEventListener(this)},save:function(){if(0==checkout.loadWaiting){checkout.setLoadWaiting("review");var e=Form.serialize(payment.form);this.agreementsForm&&(e+="&"+Form.serialize(this.agreementsForm)),e.save=!0,new Ajax.Request(this.saveUrl,{method:"post",parameters:e,onComplete:this.onComplete,onSuccess:this.onSave,onFailure:checkout.ajaxFailure.bind(checkout)})}},resetLoadWaiting:function(e){checkout.setLoadWaiting(!1,this.isSuccess)},nextStep:function(e){if(e){var t=e.responseJSON||e.responseText.evalJSON(!0)||{};if(t.redirect)return this.isSuccess=!0,void(location.href=encodeURI(t.redirect));if(t.success)this.isSuccess=!0,location.href=encodeURI(this.successUrl);else{var i=t.error_messages;Object.isArray(i)&&(i=i.join("\n").stripTags().toString()),i&&alert(i)}t.update_section&&$("checkout-"+t.update_section.name+"-load").update(t.update_section.html),t.goto_section&&checkout.gotoSection(t.goto_section,!0)}},isSuccess:!1};